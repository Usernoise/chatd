import logging
from openai import OpenAI
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥
try:
    from config import OPENAI_API_KEY_EXTENDED
    openai_api_key = OPENAI_API_KEY_EXTENDED
    logger.info("–ó–∞–≥—Ä—É–∂–µ–Ω –∫–æ–Ω—Ñ–∏–≥ –∏–∑ config.py")
except ImportError:
    # Fallback –∑–Ω–∞—á–µ–Ω–∏—è –µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
    openai_api_key = os.getenv('OPENAI_API_KEY', '')
    logger.warning("–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è fallback –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenAI –∫–ª–∏–µ–Ω—Ç–∞
if openai_api_key:
    openai_client = OpenAI(api_key=openai_api_key)
else:
    openai_client = None
    logger.warning("OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω")

GIFT_GENERATION_PROMPT = """
–¢—ã —Å–æ–∑–¥–∞–µ—à—å –ê–ë–°–£–†–î–ù–´–ï –∏ –î–ï–ë–ò–õ–¨–ù–´–ï –ø–æ–¥–∞—Ä–∫–∏ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ —á–∞—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ —á–∞—Ç–∞
2. –ü–æ–Ω—è—Ç—å –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –ø—Ä–∏–≤—ã—á–∫–∏, –∏–Ω—Ç–µ—Ä–µ—Å—ã
3. –°–æ–∑–¥–∞—Ç—å –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ê–ë–°–£–†–î–ù–´–ô –ø–æ–¥–∞—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —è–∫–æ–±—ã –∏–¥–µ–∞–ª—å–Ω–æ –µ–º—É –ø–æ–¥—Ö–æ–¥–∏—Ç

–ü–†–ê–í–ò–õ–ê –°–û–ó–î–ê–ù–ò–Ø –ü–û–î–ê–†–ö–ê:
- –ü–æ–¥–∞—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –°–û–í–ï–†–®–ï–ù–ù–û –î–ï–ë–ò–õ–¨–ù–´–ú
- –ù–æ –ø—Ä–∏ —ç—Ç–æ–º "–ª–æ–≥–∏—á–Ω–æ" –ø–æ–¥—Ö–æ–¥–∏—Ç—å –∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É —á–µ–ª–æ–≤–µ–∫–∞
- –ò—Å–ø–æ–ª—å–∑—É–π –≥–∏–ø–µ—Ä–±–æ–ª—É –∏ –∞–±—Å—É—Ä–¥–Ω–æ—Å—Ç—å
- –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—É—é –ª–µ–∫—Å–∏–∫—É
- –ü–æ–¥–∞—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–µ–ª–µ–ø—ã–º
- –ù–æ —Å "–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º" –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –µ–º—É –Ω—É–∂–Ω–æ

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:
**üéÅ –ü–û–î–ê–†–û–ö –î–õ–Ø –î–ò–†–ï–ö–¢–û–†–ê: [–ò–ú–Ø]**

**–ß—Ç–æ –¥–∞—Ä–∏–º:**
[–ê–±—Å—É—Ä–¥–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞]

**–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ:**
[–î–µ–±–∏–ª—å–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π]

**–ö–∞–∫ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
[–ï—â–µ –±–æ–ª–µ–µ –∞–±—Å—É—Ä–¥–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é]

**–ì–¥–µ –∫—É–ø–∏—Ç—å:**
[–ù–µ–ª–µ–ø–æ–µ –º–µ—Å—Ç–æ –ø–æ–∫—É–ø–∫–∏]

**–¶–µ–Ω–∞:**
[–ê–±—Å—É—Ä–¥–Ω–∞—è —Ü–µ–Ω–∞]

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:**
[–ï—â–µ –±–æ–ª–µ–µ –¥–µ–±–∏–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ –ø–æ–¥–∞—Ä–∫—É]

–ü–†–ò–ú–ï–†–´ –ê–ë–°–£–†–î–ù–´–• –ü–û–î–ê–†–ö–û–í:
- –î–ª—è –ª—é–±–∏—Ç–µ–ª—è —Å–ø–æ—Ä–∏—Ç—å: "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–µ–Ω–¥ –¥–ª—è —Å–ø–æ—Ä–æ–≤ —Å –∑–µ—Ä–∫–∞–ª–æ–º"
- –î–ª—è –º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω–æ–≥–æ: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –º–Ω–æ–≥–æ—Å–ª–æ–≤–∏—è –≤ –∫—Ä–∞—Ç–∫–æ—Å—Ç—å"
- –î–ª—è –ª—é–±–∏—Ç–µ–ª—è —à—É—Ç–æ–∫: "–ü–æ—Ä—Ç–∞—Ç–∏–≤–Ω–∞—è —Å—Ü–µ–Ω–∞ –¥–ª—è –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –ª–∏—Ñ—Ç–µ"

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º –∏ –∞–±—Å—É—Ä–¥–Ω—ã–º!
"""

def generate_director_gift(analysis_text):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–±—Å—É—Ä–¥–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ —á–∞—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
    """
    try:
        if not openai_client:
            logger.error("OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return None
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞
        import re
        director_name_match = re.search(r'\*\*–î–∏—Ä–µ–∫—Ç–æ—Ä —á–∞—Ç–∞:\*\*\s*([^\n]+?)(?:\s*\n|$)', analysis_text, re.IGNORECASE | re.MULTILINE)
        
        if not director_name_match:
            logger.warning("–ò–º—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∞–Ω–∞–ª–∏–∑–µ")
            return None
        
        director_name = director_name_match.group(1).strip()
        director_name = re.sub(r'[*_`]', '', director_name)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥–∞—Ä–æ–∫
        response = openai_client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": GIFT_GENERATION_PROMPT},
                {"role": "user", "content": f"–°–æ–∑–¥–∞–π –∞–±—Å—É—Ä–¥–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ —á–∞—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:\n\n{analysis_text}"}
            ],
            temperature=0.9,  # –í—ã—Å–æ–∫–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∞–±—Å—É—Ä–¥–Ω–æ—Å—Ç–∏
            max_tokens=1000
        )
        
        gift_description = response.choices[0].message.content
        
        logger.info(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞: {director_name}")
        return gift_description
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–∞—Ä–∫–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞: {e}")
        return None

def generate_gift_photo_prompt(gift_description):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ç–æ –ø–æ–¥–∞—Ä–∫–∞
    """
    try:
        if not openai_client:
            logger.error("OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return None
        
        response = openai_client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {
                    "role": "system", 
                    "content": """–¢—ã —Å–æ–∑–¥–∞–µ—à—å –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∞–±—Å—É—Ä–¥–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –°–æ–∑–¥–∞–π –ö–†–ê–¢–ö–ò–ô –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç (–º–∞–∫—Å–∏–º—É–º 50 —Å–ª–æ–≤)
- –ü–ï–†–ï–í–ï–î–ò –æ–ø–∏—Å–∞–Ω–∏–µ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ê–ë–°–£–†–î–ù–´–ú –∏ –°–ú–ï–®–ù–´–ú
- –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å

–í–ê–ñ–ù–û: –°–æ–∑–¥–∞–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–µ–ª–µ–ø–æ –∏ –∑–∞–±–∞–≤–Ω–æ."""
                },
                {
                    "role": "user", 
                    "content": f"–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ —Å–æ–∑–¥–∞–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–æ—Ç–æ –ø–æ–¥–∞—Ä–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è:\n\n{gift_description}"
                }
            ],
            temperature=0.7,
            max_tokens=150
        )
        
        prompt = response.choices[0].message.content.strip()
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
        enhanced_prompt = f"{prompt}, high resolution, realistic, 8k quality, studio lighting"
        
        logger.info(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–æ—Ç–æ –ø–æ–¥–∞—Ä–∫–∞: {enhanced_prompt}")
        return enhanced_prompt
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ñ–æ—Ç–æ –ø–æ–¥–∞—Ä–∫–∞: {e}")
        return None

# –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def test_gift_generation():
    """
    –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–¥–∞—Ä–∫–æ–≤
    """
    test_analysis = """
    **–î–∏—Ä–µ–∫—Ç–æ—Ä —á–∞—Ç–∞: –ò–≤–∞–Ω**
    
    **–û–ø–∏—Å–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏:**
    –ò–≤–∞–Ω - –≤–µ—á–Ω—ã–π —Å–ø–æ—Ä—â–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –∫ –¥–∏—Å–∫—É—Å—Å–∏–∏. –û–Ω –ª—é–±–∏—Ç –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –æ—Ç –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞.
    
    **–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –æ–Ω:**
    –ò–≤–∞–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á–∞—Ç–∞ —Å–≤–æ–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.
    
    **–°—Ç–∏–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
    –î–µ–º–æ–∫—Ä–∞—Ç–∏—á–Ω—ã–π –ª–∏–¥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤—Å–µ—Ö –∏ —Å–æ–±–∏—Ä–∞—Ç—å –º–Ω–µ–Ω–∏—è.
    
    **–•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã:**
    "–ö–∞–∫ –¥–µ–ª–∞ —É –≤—Å–µ—Ö?", "–ö—Ç–æ —á—Ç–æ –¥–µ–ª–∞–ª —Å–µ–≥–æ–¥–Ω—è?", "–ü–æ–Ω—è—Ç–Ω–æ, –≤—Å–µ–º —Å–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç—ã"
    """
    
    print("–¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ–¥–∞—Ä–∫–∞...")
    gift = generate_director_gift(test_analysis)
    if gift:
        print(f"–ü–æ–¥–∞—Ä–æ–∫: {gift}")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ñ–æ—Ç–æ
        photo_prompt = generate_gift_photo_prompt(gift)
        if photo_prompt:
            print(f"–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–æ—Ç–æ: {photo_prompt}")
    else:
        print("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–∞—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å")

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–∞—Ä–∫–æ–≤
    test_gift_generation() 